name: Pomodoro App CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  SONARQUBE_URL: ${{ secrets.SONARQUBE_URL }}
  NEXUS_URL: http://3.85.143.154:8081
  NEXUS_REPO: raw-releases
  NEXUS_GROUP: com/web/pomodoro
  NEXUS_ARTIFACT: pomodoro-app
  NGINX_SERVER: 3.88.108.148
  NGINX_WEB_ROOT: /var/www/html

jobs:
  build-and-test:
    name: Build, Test & Analyze
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì• Install Dependencies
        run: |
          npm install
          echo "‚úÖ Dependencies installed!"

      - name: üß™ Run Tests
        run: npm test

      - name: ‚öôÔ∏è Build Application
        run: |
          npm run build
          echo "‚úÖ Build Completed!"
          ls -lh dist/ || true

      - name: üîç SonarQube Analysis
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONARQUBE_URL }}
        with:
          args: >
            -Dsonar.projectKey=pomodoro-app-js
            -Dsonar.projectName="Pomodoro App JS"
            -Dsonar.projectVersion=${{ github.run_number }}
            -Dsonar.sources=src
            -Dsonar.sourceEncoding=UTF-8

      - name: üì¶ Package Artifact
        run: |
          VERSION="0.0.${{ github.run_number }}"
          tar -czf ${NEXUS_ARTIFACT}-${VERSION}.tar.gz -C dist .
          echo "‚úÖ Package created: ${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
          ls -lh *.tar.gz

      - name: üì§ Upload to Nexus
        run: |
          VERSION="0.0.${{ github.run_number }}"
          TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
          echo "üì§ Uploading $TARBALL to Nexus..."
          
          curl -v -u ${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }} \
            --upload-file "$TARBALL" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${TARBALL}"
          
          echo "‚úÖ Artifact uploaded successfully to Nexus!"

      - name: üìù Save Version for Deployment
        run: echo "0.0.${{ github.run_number }}" > version.txt

      - name: üíæ Upload Version Artifact
        uses: actions/upload-artifact@v4
        with:
          name: version
          path: version.txt

  deploy:
    name: Deploy to Nginx
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: üì• Download Version Artifact
        uses: actions/download-artifact@v4
        with:
          name: version

      - name: üìù Read Version
        id: version
        run: echo "VERSION=$(cat version.txt)" >> $GITHUB_OUTPUT

      - name: üöÄ Deploy to Nginx Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.NGINX_SERVER }}
          username: ${{ secrets.NGINX_SSH_USER }}
          key: ${{ secrets.NGINX_SSH_KEY }}
          envs: NEXUS_URL,NEXUS_REPO,NEXUS_GROUP,NEXUS_ARTIFACT,NGINX_WEB_ROOT
          script: |
            set -e
            cd /tmp
            rm -f *.tar.gz
            
            VERSION="${{ steps.version.outputs.VERSION }}"
            TARBALL="${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
            DOWNLOAD_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${TARBALL}"
            
            echo "‚¨áÔ∏è Downloading tarball from: $DOWNLOAD_URL"
            curl -f -u ${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }} -O "$DOWNLOAD_URL"
            
            if [[ ! -f "$TARBALL" ]]; then
              echo "‚ùå Download failed!"
              exit 1
            fi
            
            echo "üöÄ Deploying to Nginx..."
            sudo mkdir -p ${NGINX_WEB_ROOT}
            sudo rm -rf ${NGINX_WEB_ROOT}/*
            sudo tar -xzf "$TARBALL" -C ${NGINX_WEB_ROOT}/
            sudo chown -R www-data:www-data ${NGINX_WEB_ROOT}
            
            echo "‚úÖ Deployment successful! Application live on Nginx!"
